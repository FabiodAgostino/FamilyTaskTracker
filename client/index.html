<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Tasks</title>
    <meta name="description" content="Manage your family's shopping lists, notes, and calendar events all in one place.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/FamilyTaskTracker/favicon.png" />
    <link rel="shortcut icon" href="/FamilyTaskTracker/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/FamilyTaskTracker/apple-touch-icon.png" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/FamilyTaskTracker/site.webmanifest" />
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#f8b500">
    <meta name="background-color" content="#f8b500">
    
    <!-- Apple PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tasks">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Animated Splash Screen CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .splash-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f8b500 0%, #a3d900 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        .splash-container.fade-out {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        /* Nasconde splash se già vista */
        .splash-container.hidden {
            display: none !important;
        }

        /* Particelle flottanti */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            50% { transform: translateY(-100px) rotate(180deg); opacity: 1; }
        }

        /* Icona casa container */
        .icon-container {
            position: relative;
            margin-bottom: 60px;
            animation: iconEntry 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            transform: scale(0) rotate(-180deg);
        }

        @keyframes iconEntry {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            70% {
                transform: scale(1.1) rotate(10deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Icona casa */
        .home-icon {
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 8px 16px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        /* Effetto shimmer sull'icona */
        .home-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .home-icon svg {
            width: 80px;
            height: 80px;
            fill: #f8b500;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(248, 181, 0, 0.3));
        }

        /* Pulse effect per l'icona */
        .icon-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 140px;
            height: 140px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.4);
                opacity: 0;
            }
        }

        /* Testo animato */
        .splash-text {
            color: white;
            font-size: clamp(24px, 5vw, 42px);
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            opacity: 0;
            animation: textEntry 1s ease-out 0.8s forwards;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes textEntry {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Effetto typing per ogni lettera */
        .text-char {
            display: inline-block;
            opacity: 0;
            animation: charFadeIn 0.1s ease-out forwards;
            text-align: center;
        }

        @keyframes charFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading dots */
        .loading-dots {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            animation: dotsEntry 0.5s ease-out 1.5s forwards;
        }

        @keyframes dotsEntry {
            to { opacity: 1; }
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            animation: dotBounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes dotBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Version info - APPARE PRIMA */
        .version-info {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            animation: versionEntry 0.5s ease-out 0.5s forwards; /* Cambiato da 2s a 0.5s */
        }

        @keyframes versionEntry {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        #versionText {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .home-icon {
                width: 120px;
                height: 120px;
                border-radius: 24px;
            }
            
            .home-icon svg {
                width: 70px;
                height: 70px;
            }
            
            .icon-container::after {
                width: 120px;
                height: 120px;
            }
            
            .splash-text {
                padding: 0 20px;
                text-align: center !important;
                justify-content: center !important;
                margin: 0 auto;
                transform: translateX(-50%);
                position: relative;
            }
        }

        /* Background gradient animation */
        .splash-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f8b500 0%, #a3d900 100%);
            animation: gradientShift 4s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% {
                filter: hue-rotate(0deg) brightness(1);
            }
            100% {
                filter: hue-rotate(10deg) brightness(1.1);
            }
        }

        /* Content above background */
        .splash-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: center;
        }
    </style>
  </head>
  <body>
    <!-- Animated Splash Screen -->
    <div id="splash" class="splash-container">
        <!-- Particelle animate -->
        <div class="particles" id="particles"></div>
        
        <div class="splash-content">
            <!-- Icona casa animata -->
            <div class="icon-container">
                <div class="home-icon">
                    <svg viewBox="0 0 100 100">
                        <!-- Tetto più largo -->
                        <path d="M50 8 L10 48 L15 48 L50 13 L85 48 L90 48 Z"/>
                        <!-- Casa principale più larga -->
                        <path d="M15 48 L15 85 Q15 90 20 90 L38 90 L38 70 Q38 65 43 65 L57 65 Q62 65 62 70 L62 90 L80 90 Q85 90 85 85 L85 48 L50 13 Z"/>
                        <!-- Comignolo più visibile -->
                        <path d="M72 18 L72 38 L80 38 L80 22 Q80 18 76 18 Z"/>
                        <!-- Dettaglio comignolo -->
                        <rect x="72" y="16" width="8" height="4" rx="1"/>
                    </svg>
                </div>
            </div>

            <!-- Testo animato -->
            <div class="splash-text" id="splashText">
                Family Task Tracker
            </div>

            <!-- Loading dots -->
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>

            <!-- Version info -->
            <div class="version-info" id="versionInfo">
                <span id="versionText">v1.0.0</span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Splash Screen Logic + iOS Safari Fixes -->
    <script>
        // Rileva dispositivo mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768);
        }

        // Rileva se è PWA installata
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }

        // Gestione sessione - LOGICA INVERTITA
        function shouldShowSplash() {
            if (isPWA()) {
                // PWA: mostra SEMPRE l'animazione
                return true;
            }
            
            // Browser: mostra solo la prima volta per sessione
            const splashShown = sessionStorage.getItem('splashShown');
            return !splashShown;
        }

        function markSplashAsShown() {
            if (!isPWA()) {
                // Solo browser salva in sessione
                sessionStorage.setItem('splashShown', 'true');
            }
            // PWA non salva nulla, così mostra sempre
        }

        // Carica versione da version.json - SUBITO
        async function loadVersion() {
            try {
                const response = await fetch('/FamilyTaskTracker/version.json');
                const versionData = await response.json();
                const versionElement = document.getElementById('versionText');
                
                console.log('Version data loaded:', versionData);
                
                if (versionData.major !== undefined && versionData.minor !== undefined && versionData.patch !== undefined) {
                    const versionString = `v${versionData.major}.${versionData.minor}.${versionData.patch}`;
                    const buildString = versionData.build ? `.${versionData.build}` : '';
                    versionElement.textContent = versionString + buildString;
                } else if (versionData.version) {
                    versionElement.textContent = `v${versionData.version}`;
                } else {
                    versionElement.textContent = 'v1.0.0';
                }
            } catch (error) {
                console.log('Version file not found:', error);
                document.getElementById('versionText').textContent = 'v1.0.0';
            }
        }

        // Crea particelle flottanti
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 15;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 4) + 's';
                
                particlesContainer.appendChild(particle);
            }
        }

        // Effetto typing per il testo
        function animateText() {
            const textElement = document.getElementById('splashText');
            const text = textElement.textContent;
            textElement.innerHTML = '';

            text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'text-char';
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.style.animationDelay = (1 + index * 0.05) + 's';
                span.style.transform = 'translateY(20px)';
                textElement.appendChild(span);
            });
        }

        // Gestione intelligente splash
        function handleSplash() {
            const splash = document.getElementById('splash');
            
            // Se non deve mostrare splash, nascondila subito
            if (!shouldShowSplash()) {
                console.log('Browser: splash già vista in questa sessione - saltata');
                splash.classList.add('hidden');
                return;
            }

            console.log('Mostrando splash screen...');
            console.log('Modalità:', isPWA() ? 'PWA (sempre)' : 'Browser (prima volta)');
            
            // Mobile: nascondi splash iOS nativa se PWA
            if (isMobile() && isPWA()) {
                // Aspetta un momento per far passare la splash nativa iOS
                setTimeout(() => {
                    console.log('PWA mobile: mostrando animazione dopo splash nativa');
                }, 1000);
            }

            // Controlla caricamento React
            function checkReactLoaded() {
                const root = document.getElementById('root');
                const isReactLoaded = root && root.children.length > 0;
                
                if (isReactLoaded) {
                    console.log('React loaded! Root has', root.children.length, 'children');
                }
                
                return isReactLoaded;
            }
            
            let maxWaitTime = 15000;
            let checkInterval = 200;
            let elapsedTime = 0;
            
            console.log('Waiting for React to load...');
            
            const waitForReact = setInterval(() => {
                elapsedTime += checkInterval;
                
                if (checkReactLoaded()) {
                    // React caricato!
                    clearInterval(waitForReact);
                    console.log('React loaded! Hiding splash in 4 seconds...');
                    
                    // Marca come vista solo per browser
                    markSplashAsShown();
                    
                    setTimeout(() => {
                        splash.classList.add('fade-out');
                        setTimeout(() => {
                            splash.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }, 800);
                    }, 4000); // Aumentato da 2000 a 4000 (4 secondi)
                    
                } else if (elapsedTime >= maxWaitTime) {
                    // Timeout
                    clearInterval(waitForReact);
                    console.warn('React loading timeout - hiding splash anyway');
                    
                    markSplashAsShown();
                    
                    splash.classList.add('fade-out');
                    setTimeout(() => {
                        splash.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        
                        if (!checkReactLoaded()) {
                            document.body.innerHTML += `
                                <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-align:center;z-index:10000;font-family:Inter,sans-serif;">
                                    <h3 style="margin:0 0 10px 0;color:#333;">Errore di caricamento</h3>
                                    <p style="margin:0 0 15px 0;color:#666;">L'app non si è caricata correttamente</p>
                                    <button onclick="window.location.reload()" style="margin:0;padding:10px 20px;background:#f8b500;color:white;border:none;border-radius:5px;cursor:pointer;font-family:inherit;">
                                        Ricarica
                                    </button>
                                </div>`;
                        }
                    }, 800);
                } else {
                    if (elapsedTime % 2000 === 0) {
                        console.log(`Waiting for React... ${elapsedTime/1000}s elapsed`);
                    }
                }
            }, checkInterval);
        }

        // Inizializza tutto
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Modalità app:', isPWA() ? 'PWA' : 'Browser');
            console.log('Device type:', isMobile() ? 'Mobile' : 'Desktop');
            
            loadVersion(); // Carica subito la versione
            createParticles();
            animateText();
            handleSplash();
        });

        // Click per saltare (solo per testing)
        document.getElementById('splash').addEventListener('click', () => {
            console.log('Splash clicked - skipping');
            const splash = document.getElementById('splash');
            markSplashAsShown();
            splash.classList.add('fade-out');
            setTimeout(() => {
                splash.style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 800);
        });

        // iOS Safari Fixes
        let reloadAttempted = false;
        
        function checkBlankScreen() {
            const root = document.getElementById('root');
            
            if (root && root.children.length === 0 && !reloadAttempted) {
                reloadAttempted = true;
                window.location.reload();
            }
        }
        
        window.addEventListener('load', () => {
            setTimeout(checkBlankScreen, 3000);
        });
        
        function setVH() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', vh + 'px');
        }
        
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', () => {
            setTimeout(setVH, 100);
        });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
    </script>
  </body>
</html>